<html>

<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¸šåŠ¡ - æ³¨å†Œå’Œç™»å½• | ç¦¾è€³</title>
<link rel="shortcut icon" href="https://qin_hu.gitee.io/blog//favicon.ico?v=1714022378479">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://qin_hu.gitee.io/blog//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="ä¸šåŠ¡ - æ³¨å†Œå’Œç™»å½• | ç¦¾è€³ - Atom Feed" href="https://qin_hu.gitee.io/blog//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



  <meta name="description" content="å‡†å¤‡
æŠ€æœ¯æ ˆ

node,express, nodemon,bcrypt,joi

1.æ³¨å†Œ
(1)æ·»åŠ æ³¨å†Œè·¯ç”±åŠæ³¨å†Œé¡µé¢å±•ç¤º
//ç”¨æˆ·æ³¨å†Œé¡µé¢
router.get('/admin/register', (req, res) =&gt; ..." />
  <meta name="keywords" content="nodeJs" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
  <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"> -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script> -->

  <!-- and it's easy to individually load additional languages -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/night-owl.min.css">


</head>

<body>
  <div class="main">
    <div class="main-content">
      <div class="site-header">
  <a href="https://qin_hu.gitee.io/blog/">
    <img class="avatar" src="https://qin_hu.gitee.io/blog//images/avatar.png?v=1714022378479" alt="">
  </a>

  <h1 class="site-title">
    ç¦¾è€³
  </h1>
  <p class="site-description">
    é€†é£çš„æ–¹å‘ï¼Œæ›´é€‚åˆé£ç¿”ã€‚
  </p>
  <form style=" position: absolute;
  top: 50px;
  right: 150px;
  border: unset;
  outline: unset;display: flex;" id="gridea-search-form" action="https://qin_hu.gitee.io/blog//search/">
    <input placeholder="è¯·è¾“å…¥.." style="color: #222 !important;margin-right: 10px;
   " name="q" />
    <svg onclick="window.location.reload()" style="
    cursor: pointer;    filter: invert(1);" title="åˆ·æ–°é¡µé¢" class="shuaxin-icon" t="1705541456452" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
      p-id="4229" width="20" height="20">
      <path
        d="M55.935033 264.48948c0 0 85.897017-132.548409 221.81443-203.673173 135.916406-71.121743 303.368504-50.646859 413.187968 18.319527 109.819465 68.970415 146.791894 127.160016 146.791894 127.160016l94.59499-53.879895c0 0 19.576483-9.697092 19.576483 12.932142l0 338.379961c0 0 0 30.17399-22.837719 19.395191-19.210878-9.062571-226.959086-127.198289-292.424528-164.466828-35.950145-16.035251-4.365101-29.062068-4.365101-29.062068l91.284402-52.173738c0 0-52.068992-65.209619-128.278989-99.744682-81.576231-42.501826-157.948384-47.541735-251.497925-12.224097-61.002644 23.025054-132.823368 81.988166-184.553949 169.082716L55.935033 264.48948 55.935033 264.48948 55.935033 264.48948zM904.056909 711.697844c0 0-85.897017 132.550423-221.816444 203.671159-135.917413 71.12275-303.366489 50.651895-413.186961-18.315498-109.825508-68.972429-146.790886-127.165052-146.790886-127.165052L27.662591 823.768348c0 0-19.572454 9.703135-19.572454-12.932142L8.090137 472.459267c0 0 0-30.170968 22.831676-19.397205 19.211885 9.067607 226.965129 127.198289 292.430571 164.470856 35.950145 16.035251 4.366109 29.058039 4.366109 29.058039l-91.285409 52.175753c0 0 52.071006 65.206598 128.279996 99.744682 81.57321 42.498804 157.942341 47.540728 251.496918 12.222082 60.998616-23.026061 132.820346-81.983131 184.546898-169.082716L904.056909 711.697844 904.056909 711.697844 904.056909 711.697844zM904.056909 711.697844"
        fill="#2c2c2c" p-id="4230"></path>
    </svg>
  </form>
  <button style="    border: unset;
  background: #f0f8ff00;cursor: pointer;" class="theme-button" onclick="changeTheme()">
    ğŸŒ™
  </button>
  <div class="menu-container">
    
    
    <a href="https://qin_hu.gitee.io/blog/" class="menu">
      é¦–é¡µ
    </a>
    
    
    
    <a href="https://qin_hu.gitee.io/blog/archives" class="menu">
      å½’æ¡£
    </a>
    
    
    
    <a href="https://qin_hu.gitee.io/blog/tags" class="menu">
      æ ‡ç­¾
    </a>
    
    
    
    <a href="https://qin_hu.gitee.io/blog/friend" class="menu">
      å‹é“¾
    </a>
    
    
    
    <a href="https://qin_hu.gitee.io/blog/about" class="menu">
      å…³äº
    </a>
    
    
  </div>
  <div class="social-container">
    
    
    <a href="https://github.com/QinCongH" target="_blank">
      <i class="ri-github-line"></i>
    </a>
    
    
    
    
    
    
    
    
    
    
  </div>
</div>
<script>
  window.addEventListener('load', () => {
    const themeType = localStorage.getItem('theme')
    const bodyDom = document.querySelector('body')
    const themeButtonDom = document.querySelector('.theme-button')
    // console.log(1111111111111111, themeType)
    if (themeType === 'light') {
      bodyDom.removeAttribute('thmem-dark')
      themeButtonDom.textContent = 'ğŸŒ™'
      localStorage.setItem('theme', 'light')
    } else {
      bodyDom.setAttribute('thmem-dark', '')
      themeButtonDom.textContent = 'ğŸŒ'
      localStorage.setItem('theme', 'dark')
    }
  })

  function changeTheme() {
    const bodyDom = document.querySelector('body')
    const themeButtonDom = document.querySelector('.theme-button')
    const attr = bodyDom.hasAttribute('thmem-dark')
    if (attr) {
      bodyDom.removeAttribute('thmem-dark')
      themeButtonDom.textContent = 'ğŸŒ™'
      localStorage.setItem('theme', 'light')
    } else {
      bodyDom.setAttribute('thmem-dark', '')
      themeButtonDom.textContent = 'ğŸŒ'
      localStorage.setItem('theme', 'dark')
    }
  }
</script>
      <div class="post-detail">
        <article class="post">
          <h2 class="post-title">
            ä¸šåŠ¡ - æ³¨å†Œå’Œç™»å½•
          </h2>
          <div class="post-info">
            <span>
              2024-01-09
            </span>
            <span>
              15 min read
            </span>
            
            <a href="https://qin_hu.gitee.io/blog/tag/E7wJE8AQv/" class="post-tag">
              # nodeJs
            </a>
            
          </div>
          
          <div class="post-content-wrapper">
            <div class="post-content" v-pre>
              <h1 id="å‡†å¤‡">å‡†å¤‡</h1>
<h2 id="æŠ€æœ¯æ ˆ">æŠ€æœ¯æ ˆ</h2>
<blockquote>
<p>node,express, nodemon,bcrypt,joi</p>
</blockquote>
<h1 id="1æ³¨å†Œ">1.æ³¨å†Œ</h1>
<h2 id="1æ·»åŠ æ³¨å†Œè·¯ç”±åŠæ³¨å†Œé¡µé¢å±•ç¤º">(1)æ·»åŠ æ³¨å†Œè·¯ç”±åŠæ³¨å†Œé¡µé¢å±•ç¤º</h2>
<pre><code>//ç”¨æˆ·æ³¨å†Œé¡µé¢
router.get('/admin/register', (req, res) =&gt; {
    const {
        message
    } = req.query
    res.render(&quot;admin/user-edit.html&quot;, {
        message
    })
})

</code></pre>
<h2 id="2è§†å›¾å±‚è®¾ç½®formæäº¤æ•°æ®æœåŠ¡ç«¯å¾—åˆ°æ•°æ®">(2)è§†å›¾å±‚è®¾ç½®formæäº¤æ•°æ®,æœåŠ¡ç«¯å¾—åˆ°æ•°æ®</h2>
<pre><code>      &lt;form class=&quot;form-container&quot; method=&quot;post&quot; action=&quot;/admin/register&quot;&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;ç”¨æˆ·å&lt;/label&gt;
                &lt;input type=&quot;text&quot; name=&quot;username&quot; class=&quot;form-control&quot; placeholder=&quot;è¯·è¾“å…¥ç”¨æˆ·å&quot;&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;é‚®ç®±&lt;/label&gt;
                &lt;input type=&quot;email&quot; name=&quot;email&quot; class=&quot;form-control&quot; placeholder=&quot;è¯·è¾“å…¥é‚®ç®±åœ°å€&quot;&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;å¯†ç &lt;/label&gt;
                &lt;input type=&quot;password&quot; name=&quot;password&quot; class=&quot;form-control&quot; placeholder=&quot;è¯·è¾“å…¥å¯†ç &quot;&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;è§’è‰²&lt;/label&gt;
                &lt;select class=&quot;form-control&quot; name=&quot;role&quot;&gt;
                    &lt;option value=&quot;normal&quot;&gt;æ™®é€šç”¨æˆ·&lt;/option&gt;
                    &lt;option value=&quot;admin&quot;&gt;è¶…çº§ç®¡ç†å‘˜&lt;/option&gt;
                &lt;/select&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label&gt;çŠ¶æ€&lt;/label&gt;
                &lt;select class=&quot;form-control&quot; name=&quot;state&quot;&gt;
                    &lt;option value=&quot;0&quot;&gt;å¯ç”¨&lt;/option&gt;
                    &lt;option value=&quot;1&quot;&gt;ç¦ç”¨&lt;/option&gt;
                &lt;/select&gt;
            &lt;/div&gt;
            &lt;div class=&quot;buttons&quot;&gt;
                &lt;input type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;
            &lt;/div&gt;
        &lt;/form&gt;
</code></pre>
<h2 id="3è§†å›¾å±‚éªŒè¯-è§†å›¾å±‚éªŒè¯è¡¨å•å†…å®¹æ˜¯å¦å¡«å†™">(3)è§†å›¾å±‚éªŒè¯ã€‚ è§†å›¾å±‚éªŒè¯è¡¨å•å†…å®¹æ˜¯å¦å¡«å†™</h2>
<pre><code>//1.è¡¨å•åºåˆ—åŒ–
function serializeToJson(form) {
    var result={}
    var f = form.serializeArray()
    f.forEach(function (item) {
        result[item.name] = item.value
    })
    return result
}


//2.åˆ¤æ–­è¡¨å•å­—æ®µ
    var result = serializeToJson(Form)//åºåˆ—åŒ–è·å–è¡¨å•
       if (result.email.trim().length == 0) {
            alert(&quot;è¯·è¾“å…¥é‚®ç®±&quot;)
            // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤
            return false
        }

</code></pre>
<h2 id="4æœåŠ¡ç«¯éªŒè¯">(4)æœåŠ¡ç«¯éªŒè¯ã€‚</h2>
<ul>
<li>éªŒè¯è¡¨å•å†…å®¹æ˜¯å¦ç¬¦åˆæ ¼å¼ ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¨¡å— joi</li>
</ul>
<pre><code>    const schema = joi.object({
        username: joi.string().min(3).max(20).required().error(new Error(&quot;ç”¨æˆ·åè®¾ç½®é”™è¯¯&quot;)),
        password: joi.string().pattern(new RegExp('^[a-zA-Z0-9]{3,30}$')).required().error(new Error(&quot;å¯†ç è®¾ç½®é”™è¯¯&quot;)),
        email: joi.string().required().email({
            minDomainSegments: 2,
            tlds: {
                allow: ['com', 'net']
            }
        }),
        role: joi.string().valid('normal', 'admin').required().error(new Error(&quot;è§’è‰²å€¼è®¾ç½®é”™è¯¯&quot;)),
        state: joi.number().valid(0, 1).required().error(new Error(&quot;çŠ¶æ€å€¼è®¾ç½®é”™è¯¯&quot;)),
    })

    try { //éªŒè¯é€šè¿‡æ‰§è¡Œ
        // å®ç°éªŒè¯
        await schema.validateAsync(req.body)

    } catch (e) { // éªŒè¯é”™è¯¯æ‰§è¡Œ
        //é‡å®šå‘åˆ°ç¼–è¾‘é¡µï¼Œå¹¶å°†é”™è¯¯ä¿¡æ¯ä¼ è¿‡å»
        return res.redirect(`/admin/register?message=${e.message}`)
    }


</code></pre>
<ul>
<li>éªŒè¯æ³¨å†Œçš„é‚®ç®±åœ°å€æ˜¯å¦æ³¨å†Œè¿‡,ä½¿ç”¨mongooseæŸ¥è¯¢æ–¹æ³•</li>
</ul>
<pre><code>    // 2.éªŒè¯ç”¨æˆ·ï¼ˆä½¿ç”¨é‚®ç®±ï¼‰æ˜¯å¦è¢«æ³¨å†Œ.å¦‚æœæ‰¾å¾—åˆ°emailè¯´æ˜æ•°æ®åº“å­˜åœ¨ï¼Œå¦åˆ™ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±å®è¡Œæ·»åŠ 
    let user = await User.findOne({
        email: req.body.email
    })
    if (user) { //æŸ¥è¯¢åˆ°äº†ï¼Œåˆ™ä¸èƒ½æ³¨å†Œï¼Œé‡å®šå‘åˆ°æ³¨å†Œé¡µé¢
        return res.redirect(`/admin/register?message=é‚®ç®±å·²è¢«æ³¨å†Œ`)
    }
</code></pre>
<h2 id="5å¯†ç åŠ å¯†æŠ€æœ¯bcrypt">(5)å¯†ç åŠ å¯†æŠ€æœ¯bcrypt</h2>
<pre><code>    // 3.å¯¹å¯†ç åŠ å¯†
    // 3.1ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
    const salt = await bcrypt.genSalt(10)
    // 3.2 åŠ å¯†æ›¿æ¢ä»£ç 
    req.body.password = await bcrypt.hash(req.body.password, salt)
</code></pre>
<h2 id="6å°†ä¿¡æ¯æ·»åŠ åˆ°æ•°æ®åº“">(6)å°†ä¿¡æ¯æ·»åŠ åˆ°æ•°æ®åº“</h2>
<pre><code>    await new User(req.body).save()
    //æˆ–è€… 
	//await User.create(req.body)

</code></pre>
<h2 id="7é‡å®šå‘åˆ°ç”¨æˆ·é¡µé¢">(7)é‡å®šå‘åˆ°ç”¨æˆ·é¡µé¢</h2>
<pre><code> res.redirect('/admin/user')
</code></pre>
<h1 id="2ç™»å½•">2.ç™»å½•</h1>
<h2 id="1åˆ›å»ºç”¨æˆ·é›†åˆç™»å½•ç”¨æˆ·">ï¼ˆ1ï¼‰åˆ›å»ºç”¨æˆ·é›†åˆï¼Œç™»å½•ç”¨æˆ·</h2>
<ul>
<li>è¿æ¥æ•°æ®åº“</li>
<li>åˆ›å»ºç”¨æˆ·é›†åˆ</li>
<li>åˆå§‹åŒ–ç”¨æˆ·</li>
</ul>
<blockquote>
<p>user.js</p>
</blockquote>
<pre><code>// åˆ›å»ºç”¨æˆ·é›†åˆ
var mongoose = require('mongoose')
//2.è¿æ¥å¹¶åˆ›å»ºæ•°æ®åº“
mongoose.connect(&quot;mongodb://localhost/blog&quot;).then(() =&gt; {
    console.log('è¿æ¥æˆåŠŸ');
}).catch(() =&gt; {
    console.log('è¿æ¥å¤±è´¥');
})
const Schema = mongoose.Schema
var userSchema = new Schema({
    username: {
        type: String,
        required: true, //ç”¨æˆ·å¿…é¡»
        minlength: 2,
        maxlength: 20
    },
    email: {
        type: String,
        unique: true, //ä¿è¯å”¯ä¸€æ€§ï¼ˆä¸é‡å¤ï¼‰
    },
    password: {
        type: String,
        required: true
    },
    role: { //adminè¶…çº§ç®¡ç†å‘˜
        type: String,
        required: true
    },
    state: { //0ä¸ºå¯ç”¨ï¼Œ1ä¸ºç¦ç”¨
        type: Number,
        default: 0
    }

})


// æ’å…¥æ•°æ®æ£€æµ‹ï¼ˆåˆå§‹åŒ–ç”¨æˆ·ï¼‰
// User.create({
//     username:'admin',
//     email:'333@qq.com',
//     password:'admin',
//     role:'admin',
//     state:0
// }).then(()=&gt;{
//     console.log('åˆ›å»ºæˆåŠŸ');
// }).catch(()=&gt;{
//     console.log('åˆ›å»ºå¤±è´¥');
// })
//å°†ç”¨æˆ·é›†åˆä½œä¸ºæ¨¡å—æˆå‘˜å¯¼å‡º
// å®ä¾‹åŒ–æ–‡æ¡£ç»“æ„ï¼ˆå°†æ–‡æ¡£ç»“æ„å‘å¸ƒä¸ºæ¨¡å‹ï¼‰
module.exports = mongoose.model('User', userSchema)
</code></pre>
<h2 id="2è§†å›¾å±‚è®¾ç½®formæäº¤æ•°æ®">ï¼ˆ2ï¼‰è§†å›¾å±‚è®¾ç½®formæäº¤æ•°æ®</h2>
<blockquote>
<p>login.html</p>
</blockquote>
<pre><code>     &lt;form id=&quot;loginForm&quot; action=&quot;/login&quot; method=&quot;post&quot;&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label&gt;é‚®ä»¶&lt;/label&gt;
                        &lt;input type=&quot;email&quot; name=&quot;email&quot; class=&quot;form-control&quot; placeholder=&quot;è¯·è¾“å…¥é‚®ä»¶åœ°å€&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;form-group&quot;&gt;
                        &lt;label&gt;å¯†ç &lt;/label&gt;
                        &lt;input type=&quot;password&quot; name=&quot;password&quot; class=&quot;form-control&quot; placeholder=&quot;è¯·è¾“å…¥å¯†ç &quot;&gt;
                    &lt;/div&gt;
                    &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary loginForm&quot;&gt;ç™»å½•&lt;/button&gt;
                &lt;/form&gt;
</code></pre>
<h2 id="3è§†å›¾å±‚éªŒè¯-è§†å›¾å±‚éªŒè¯è¡¨å•å†…å®¹æ˜¯å¦å¡«å†™å¦‚æœæ²¡å¡«å†™å®Œæ•´åˆ™é˜»æ­¢ç™»å½•">(3)è§†å›¾å±‚éªŒè¯ã€‚ è§†å›¾å±‚éªŒè¯è¡¨å•å†…å®¹æ˜¯å¦å¡«å†™ï¼Œå¦‚æœæ²¡å¡«å†™å®Œæ•´åˆ™é˜»æ­¢ç™»å½•</h2>
<blockquote>
<p>è§†å›¾å±‚jsæ–‡ä»¶</p>
</blockquote>
<pre><code>//1.è¡¨å•åºåˆ—åŒ–
function serializeToJson(form) {
    var result={}
    var f = form.serializeArray()
    f.forEach(function (item) {
        result[item.name] = item.value
    })
    return result
}


//2.åˆ¤æ–­è¡¨å•å­—æ®µ
    var result = serializeToJson(Form)//åºåˆ—åŒ–è·å–è¡¨å•
       if (result.email.trim().length == 0) {
            alert(&quot;è¯·è¾“å…¥é‚®ç®±&quot;)
            // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤
            return false
        }
</code></pre>
<h2 id="4æœåŠ¡ç«¯éªŒè¯-2">(4)æœåŠ¡ç«¯éªŒè¯ã€‚</h2>
<ul>
<li>éªŒè¯é‚®ç®±å’Œå¯†ç æ˜¯å¦è¾“å…¥ï¼ˆé”™è¯¯çŠ¶æ€ç 400ï¼‰</li>
<li>æœåŠ¡å™¨æ¥æ”¶æ•°æ®ï¼ŒéªŒè¯è¡¨å•å†…å®¹æ˜¯å¦å¡«å†™ï¼Œå¦‚æœæ²¡å¡«å†™å®Œæ•´åˆ™é˜»æ­¢ç™»å½•</li>
</ul>
<h3 id="41åˆ›å»ºç™»å½•è·¯ç”±é¡µé¢">ï¼ˆ4.1ï¼‰åˆ›å»ºç™»å½•è·¯ç”±é¡µé¢</h3>
<pre><code>router.get('/login', function (req, res) {
    // res.status(200).send(&quot;åå°ç®¡ç†é¡µé¢&quot;)
    // res.send(&quot;åå°ç®¡ç†é¡µé¢&quot;)
    res.render(&quot;admin/login.html&quot;)
})

</code></pre>
<h3 id="42ç™»å½•åŠŸèƒ½æ“ä½œ">ï¼ˆ4.2ï¼‰ç™»å½•åŠŸèƒ½æ“ä½œ</h3>
<pre><code>router.post('/login', async (req, res) =&gt; {

    const {
        email,
        password
    } = req.body //è§£æ„è¯­æ³•ï¼ŒæŠŠå¯¹è±¡ä¸­çš„req.body.emailçš„å€¼èµ‹å€¼ç»™äº†emailï¼ŒæŠŠå¯¹è±¡ä¸­çš„req.body.passwordçš„å€¼èµ‹å€¼ç»™äº†password


    // res.send('ok')
    // 1.éªŒè¯ç”¨æˆ·æ˜¯å¦è¾“å…¥äº†é‚®ç®±å’Œå¯†ç ï¼ˆéªŒè¯formè¡¨å•ä¼ è¿‡æ¥çš„æ•°æ®æ˜¯å¦å­˜åœ¨ï¼‰
    if (email.trim().length == 0 || password.trim().length == 0)
        return res.status(400).render(&quot;admin/err.html&quot;, {
            msg: 'é‚®ç®±æˆ–è€…å¯†ç é”™è¯¯'
        }) //çŠ¶æ€ç 400 è¯·æ±‚ä¿¡æ¯æœ‰é—®é¢˜

    // 2.æ ¹æ®é‚®ç®±åœ°å€æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å­˜åœ¨
    // æŸ¥è¯¢åˆ°ç”¨æˆ·ï¼Œåˆ™userè¡¨ä¸­æœ‰å¯¹è±¡ï¼Œå¦åˆ™ä¸ºç©º
    let user = await User.findOne({
        email
    })
    if (user) { //æŸ¥è¯¢åˆ°äº†
        // å°†formä¼ é€’çš„å¯†ç å’Œæ•°æ®åº“ä¸­çš„è¿›è¡Œæ¯”å¯¹
		 let isValid = await bcrypt.compare(password, user.password)
        if (isValid) {
            req.session.username=user.username //å°†ç”¨æˆ·åå­˜å‚¨åˆ°sessionå¯¹è±¡
            // res.send('ç™»å½•æˆåŠŸ')
            req.app.locals.userInfo=user;//å°†ç”¨æˆ·ä¿¡æ¯å­˜æ”¾åˆ°æ¨¡æ¿ req.app.locals.åç§°=å˜é‡
            res.redirect('/user')
        } else {
            res.status(400).render(&quot;admin/err.html&quot;, {
                msg: 'é‚®ç®±æˆ–è€…å¯†ç é”™è¯¯'
            }) //çŠ¶æ€ç 400 è¯·æ±‚ä¿¡æ¯æœ‰é—®é¢˜
        }
    } else { //æ²¡æŸ¥è¯¢åˆ°
        res.status(400).render(&quot;admin/err.html&quot;, {
            msg: 'é‚®ç®±æˆ–è€…å¯†ç é”™è¯¯'
        }) //çŠ¶æ€ç 400 è¯·æ±‚ä¿¡æ¯æœ‰é—®é¢˜
    }
})

</code></pre>
<blockquote>
<p>æ­¤å¤„æ³¨æ„ï¼šéœ€è¦å¦å¤–å¸Œæœ›ä¸€ä¸ªerr.htmlæ–‡ä»¶æ¥æ˜¾ç¤ºé”™è¯¯é¡µé¢</p>
</blockquote>
<h2 id="5å¯†ç æ¯”å¯¹æˆåŠŸæ‰èƒ½ç™»å½•å¯†ç åŠ å¯†æŠ€æœ¯bcrypt">(5)å¯†ç æ¯”å¯¹æˆåŠŸæ‰èƒ½ç™»å½•(å¯†ç åŠ å¯†æŠ€æœ¯bcrypt)</h2>
<pre><code> let isValid = await bcrypt.compare(password, user.password)
</code></pre>
<h2 id="6cookieä¸session">(6)<a href="https://www.cnblogs.com/mywifeisMsHu/p/15741441.html">cookieä¸session</a></h2>
<ul>
<li>è®¾ç½®session</li>
</ul>
<blockquote>
<p>app.js</p>
</blockquote>
<pre><code>const session = require('express-session') //å¯¼å…¥express-session
//é…ç½®session
app.use(session({
    secret: 'secret:key',
    saveUninitialized:false,//é€€å‡ºç™»å½•ä¸ä¼šå­˜å‚¨cookie
    cookie:{
        maxAge:24*60*60*1000    //è®¾ç½®cookieè¿‡æœŸæ—¶é—´ä¸ºä¸€å¤©ï¼Œå¦‚æœä¸è®¾ç½®æµè§ˆå™¨å…³é—­åˆ™ç™»å½•çŠ¶æ€å¤±æ•ˆ
    }
}))
</code></pre>
<ul>
<li>ä½¿ç”¨session</li>
</ul>
<pre><code>   req.session.username = user.username //å°†ç”¨æˆ·åå­˜å‚¨åˆ°sessionå¯¹è±¡
</code></pre>
<h2 id="7ç”¨æˆ·é€€å‡º">(7)ç”¨æˆ·é€€å‡º</h2>
<blockquote>
<p>ç‚¹å‡»ç”¨æˆ·é€€å‡ºæŒ‰é’®åˆ é™¤cookie,é‡å®šå‘åˆ°ç™»å½•é¡µé¢</p>
</blockquote>
<pre><code>//3.ç”¨æˆ·ç™»å½•é€€å‡º
router.get(&quot;/admin/logout&quot;, (req, res) =&gt; {
    //åˆ é™¤cookie
    req.session.destroy(function () {
        //åˆ é™¤Cookie
        res.clearCookie('connect.sid') // res.clearCookie(cookieåç§°)
        //é‡å®šå‘åˆ°ç™»å½•
        res.redirect('/admin/login')
    })
    //åˆ é™¤session
    //é‡å®šå‘åˆ°ç™»å½•é¡µé¢
})

</code></pre>
<h2 id="8ç™»å½•æ‹¦æˆª">(8)ç™»å½•æ‹¦æˆª</h2>
<ul>
<li>1.åˆ¤æ–­æ˜¯å¦ä¸ºç™»å½•é¡µé¢</li>
</ul>
<blockquote>
<p>å½“é¡µé¢ä¸æ˜¯ç™»å½•çš„é¡µé¢ï¼Œä½¿ç”¨æ‹¦æˆªå™¨å°†é¡µé¢é‡å®šå‘åˆ°ç™»å½•é¡µé¢</p>
</blockquote>
<ul>
<li>2.åˆ¤æ–­æ˜¯å¦ä¸ºç™»å½•çŠ¶æ€</li>
</ul>
<blockquote>
<p>åˆ¤æ–­sessionæ˜¯å¦å­˜åœ¨æ¥åˆ¤æ–­æ˜¯å¦ä¸ºç™»å½•çŠ¶æ€</p>
</blockquote>
<pre><code>//æ‹¦æˆªå™¨,æ‹¦æˆªç™»å½•çŠ¶æ€
router.use('/admin', (req, res, next) =&gt; {
    //1.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯ç™»å½•é¡µé¢
    // 2.åˆ¤æ–­ç”¨æˆ·ç™»å½•çŠ¶æ€
    //å¦‚æœç™»å½•ï¼Œå°†è¯·æ±‚æ”¾è¡Œ
    //å¦‚æœæœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•
    if (req.url != &quot;/login&quot; &amp;&amp; !req.session.username) { //å¦‚æœæœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•
        res.redirect(&quot;/admin/login&quot;)
    } else { //å¦‚æœç™»å½•ï¼Œå°†è¯·æ±‚æ”¾è¡Œ

        next()
    }
})
</code></pre>
<h1 id="ä»£ç ">ä»£ç </h1>
<hr>
<blockquote>
<p>register.js</p>
</blockquote>
<pre><code>const express = require('express')
const User = require('../../model/user') //useræ•°æ®è¡¨
const joi = require('joi')
const bcrypt = require('bcrypt')
let router = express.Router() //åˆ›å»ºrouter
//ç”¨æˆ·é¦–é¡µ
router.get('/admin/user', (req, res) =&gt; {
    res.render(&quot;admin/user.html&quot;, {
        msg: req.session.username
    })
})

//ç”¨æˆ·æ³¨å†Œé¡µé¢
router.get('/admin/register', (req, res) =&gt; {
    const {
        message
    } = req.query
    res.render(&quot;admin/user-edit.html&quot;, {
        message
    })
})

// ç”¨æˆ·æ³¨å†Œå¤„ç†
router.post('/admin/register', async (req, res) =&gt; {
    // 1.éªŒè¯è¡¨å•å†…å®¹æ˜¯å¦ç¬¦åˆæ ¼å¼ 
    //åˆ›å»ºéªŒè¯è§„åˆ™
    const schema = joi.object({
        username: joi.string().min(3).max(20).required().error(new Error(&quot;ç”¨æˆ·åè®¾ç½®é”™è¯¯&quot;)),
        password: joi.string().pattern(new RegExp('^[a-zA-Z0-9]{3,30}$')).required().error(new Error(&quot;å¯†ç è®¾ç½®é”™è¯¯&quot;)),
        email: joi.string().required().email({
            minDomainSegments: 2,
            tlds: {
                allow: ['com', 'net']
            }
        }),
        role: joi.string().valid('normal', 'admin').required().error(new Error(&quot;è§’è‰²å€¼è®¾ç½®é”™è¯¯&quot;)),
        state: joi.number().valid(0, 1).required().error(new Error(&quot;çŠ¶æ€å€¼è®¾ç½®é”™è¯¯&quot;)),
    })

    try { //éªŒè¯é€šè¿‡æ‰§è¡Œ
        // å®ç°éªŒè¯
        await schema.validateAsync(req.body)

    } catch (e) { // éªŒè¯é”™è¯¯æ‰§è¡Œ
        //é‡å®šå‘åˆ°ç¼–è¾‘é¡µï¼Œå¹¶å°†é”™è¯¯ä¿¡æ¯ä¼ è¿‡å»
        return res.redirect(`/admin/register?message=${e.message}`)
    }

    // 2.éªŒè¯ç”¨æˆ·ï¼ˆä½¿ç”¨é‚®ç®±ï¼‰æ˜¯å¦è¢«æ³¨å†Œ.å¦‚æœæ‰¾å¾—åˆ°emailè¯´æ˜æ•°æ®åº“å­˜åœ¨ï¼Œå¦åˆ™ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±å®è¡Œæ·»åŠ 
    let user = await User.findOne({
        email: req.body.email
    })
    if (user) { //æŸ¥è¯¢åˆ°äº†ï¼Œåˆ™ä¸èƒ½æ³¨å†Œï¼Œé‡å®šå‘åˆ°æ³¨å†Œé¡µé¢
        return res.redirect(`/admin/register?message=é‚®ç®±å·²è¢«æ³¨å†Œ`)
    }
    // 3.å¯¹å¯†ç åŠ å¯†
    // 3.1ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
    const salt = await bcrypt.genSalt(10)
    // 3.2 åŠ å¯†æ›¿æ¢ä»£ç 
    req.body.password = await bcrypt.hash(req.body.password, salt)
    // 3.3
    // req.body.password=password
    //4.å¢åŠ ä¿¡æ¯
    await new User(req.body).save()
    // await User.create(req.body)
    res.redirect('/admin/user')
})


//404é¡µé¢
router.use('/', (req, res, next) =&gt; {
    res.send('404')
})
module.exports = router //å¯¼å‡ºæ¨¡å—
</code></pre>
<hr>
<blockquote>
<p>login.js</p>
</blockquote>
<pre><code>const express = require('express')
const User = require('../../model/user') //useræ•°æ®è¡¨
const bcrypt = require('bcrypt')
let router = express.Router() //åˆ›å»ºrouter
//è·¯ç”±
//æ‹¦æˆªå™¨,æ‹¦æˆªç™»å½•çŠ¶æ€
router.use('/admin', (req, res, next) =&gt; {
    //1.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯ç™»å½•é¡µé¢
    // 2.åˆ¤æ–­ç”¨æˆ·ç™»å½•çŠ¶æ€
    //å¦‚æœç™»å½•ï¼Œå°†è¯·æ±‚æ”¾è¡Œ
    //å¦‚æœæœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•
    if (req.url != &quot;/login&quot; &amp;&amp; !req.session.username) { //å¦‚æœæœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•
        res.redirect(&quot;/admin/login&quot;)
    } else { //å¦‚æœç™»å½•ï¼Œå°†è¯·æ±‚æ”¾è¡Œ

        next()
    }
})
// 1.ç™»å½•é¡µé¢
router.get('/admin/login', function (req, res) {
    // res.status(200).send(&quot;åå°ç®¡ç†é¡µé¢&quot;)
    // res.send(&quot;åå°ç®¡ç†é¡µé¢&quot;)
    res.render(&quot;admin/login.html&quot;)
})

// 2.ç™»å½•åŠŸèƒ½å®ç°
router.post('/admin/login', async (req, res) =&gt; {

    const {
        email,
        password
    } = req.body //è§£æ„è¯­æ³•ï¼ŒæŠŠå¯¹è±¡ä¸­çš„req.body.emailçš„å€¼èµ‹å€¼ç»™äº†emailï¼ŒæŠŠå¯¹è±¡ä¸­çš„req.body.passwordçš„å€¼èµ‹å€¼ç»™äº†password


    // res.send('ok')
    // 1.éªŒè¯ç”¨æˆ·æ˜¯å¦è¾“å…¥äº†é‚®ç®±å’Œå¯†ç ï¼ˆéªŒè¯formè¡¨å•ä¼ è¿‡æ¥çš„æ•°æ®æ˜¯å¦å­˜åœ¨ï¼‰
    if (email.trim().length == 0 || password.trim().length == 0)
        return res.status(400).render(&quot;admin/err.html&quot;, {
            msg: 'é‚®ç®±æˆ–è€…å¯†ç é”™è¯¯'
        }) //çŠ¶æ€ç 400 è¯·æ±‚ä¿¡æ¯æœ‰é—®é¢˜

    // 2.æ ¹æ®é‚®ç®±åœ°å€æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å­˜åœ¨
    // æŸ¥è¯¢åˆ°ç”¨æˆ·ï¼Œåˆ™userè¡¨ä¸­æœ‰å¯¹è±¡ï¼Œå¦åˆ™ä¸ºç©º
    let user = await User.findOne({
        email
    })
    if (user) { //æŸ¥è¯¢åˆ°äº†
        // å°†formä¼ é€’çš„å¯†ç å’Œæ•°æ®åº“ä¸­çš„è¿›è¡Œæ¯”å¯¹

        let isValid = await bcrypt.compare(password, user.password)

        if (isValid) {
            req.session.username = user.username //å°†ç”¨æˆ·åå­˜å‚¨åˆ°sessionå¯¹è±¡
            // res.send('ç™»å½•æˆåŠŸ')
            req.app.locals.userInfo = user; //å°†ç”¨æˆ·ä¿¡æ¯å­˜æ”¾åˆ°æ¨¡æ¿ req.app.locals.åç§°=å˜é‡
            res.redirect('/admin/user')
        } else {
            res.status(400).render(&quot;admin/err.html&quot;, {
                msg: 'é‚®ç®±æˆ–è€…å¯†ç é”™è¯¯'
            }) //çŠ¶æ€ç 400 è¯·æ±‚ä¿¡æ¯æœ‰é—®é¢˜
        }
    } else { //æ²¡æŸ¥è¯¢åˆ°
        res.status(400).render(&quot;admin/err.html&quot;, {
            msg: 'é‚®ç®±æˆ–è€…å¯†ç é”™è¯¯'
        }) //çŠ¶æ€ç 400 è¯·æ±‚ä¿¡æ¯æœ‰é—®é¢˜
    }
})


//3.ç”¨æˆ·ç™»å½•é€€å‡º
router.get(&quot;/admin/logout&quot;, (req, res) =&gt; {
    //åˆ é™¤cookie
    req.session.destroy(function () {
        //åˆ é™¤Cookie
        res.clearCookie('connect.sid') // res.clearCookie(cookieåç§°)
        //é‡å®šå‘åˆ°ç™»å½•
        res.redirect('/admin/login')
    })
    //åˆ é™¤session
    //é‡å®šå‘åˆ°ç™»å½•é¡µé¢
})

module.exports = router //å¯¼å‡ºæ¨¡å—
</code></pre>

            </div>
            <div class="toc-container">
              <ul class="markdownIt-TOC">
<li><a href="#%E5%87%86%E5%A4%87">å‡†å¤‡</a>
<ul>
<li><a href="#%E6%8A%80%E6%9C%AF%E6%A0%88">æŠ€æœ¯æ ˆ</a></li>
</ul>
</li>
<li><a href="#1%E6%B3%A8%E5%86%8C">1.æ³¨å†Œ</a>
<ul>
<li><a href="#1%E6%B7%BB%E5%8A%A0%E6%B3%A8%E5%86%8C%E8%B7%AF%E7%94%B1%E5%8F%8A%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA">(1)æ·»åŠ æ³¨å†Œè·¯ç”±åŠæ³¨å†Œé¡µé¢å±•ç¤º</a></li>
<li><a href="#2%E8%A7%86%E5%9B%BE%E5%B1%82%E8%AE%BE%E7%BD%AEform%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BE%97%E5%88%B0%E6%95%B0%E6%8D%AE">(2)è§†å›¾å±‚è®¾ç½®formæäº¤æ•°æ®,æœåŠ¡ç«¯å¾—åˆ°æ•°æ®</a></li>
<li><a href="#3%E8%A7%86%E5%9B%BE%E5%B1%82%E9%AA%8C%E8%AF%81-%E8%A7%86%E5%9B%BE%E5%B1%82%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E5%86%85%E5%AE%B9%E6%98%AF%E5%90%A6%E5%A1%AB%E5%86%99">(3)è§†å›¾å±‚éªŒè¯ã€‚ è§†å›¾å±‚éªŒè¯è¡¨å•å†…å®¹æ˜¯å¦å¡«å†™</a></li>
<li><a href="#4%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%AA%8C%E8%AF%81">(4)æœåŠ¡ç«¯éªŒè¯ã€‚</a></li>
<li><a href="#5%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AFbcrypt">(5)å¯†ç åŠ å¯†æŠ€æœ¯bcrypt</a></li>
<li><a href="#6%E5%B0%86%E4%BF%A1%E6%81%AF%E6%B7%BB%E5%8A%A0%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93">(6)å°†ä¿¡æ¯æ·»åŠ åˆ°æ•°æ®åº“</a></li>
<li><a href="#7%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0%E7%94%A8%E6%88%B7%E9%A1%B5%E9%9D%A2">(7)é‡å®šå‘åˆ°ç”¨æˆ·é¡µé¢</a></li>
</ul>
</li>
<li><a href="#2%E7%99%BB%E5%BD%95">2.ç™»å½•</a>
<ul>
<li><a href="#1%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E9%9B%86%E5%90%88%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7">ï¼ˆ1ï¼‰åˆ›å»ºç”¨æˆ·é›†åˆï¼Œç™»å½•ç”¨æˆ·</a></li>
<li><a href="#2%E8%A7%86%E5%9B%BE%E5%B1%82%E8%AE%BE%E7%BD%AEform%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE">ï¼ˆ2ï¼‰è§†å›¾å±‚è®¾ç½®formæäº¤æ•°æ®</a></li>
<li><a href="#3%E8%A7%86%E5%9B%BE%E5%B1%82%E9%AA%8C%E8%AF%81-%E8%A7%86%E5%9B%BE%E5%B1%82%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E5%86%85%E5%AE%B9%E6%98%AF%E5%90%A6%E5%A1%AB%E5%86%99%E5%A6%82%E6%9E%9C%E6%B2%A1%E5%A1%AB%E5%86%99%E5%AE%8C%E6%95%B4%E5%88%99%E9%98%BB%E6%AD%A2%E7%99%BB%E5%BD%95">(3)è§†å›¾å±‚éªŒè¯ã€‚ è§†å›¾å±‚éªŒè¯è¡¨å•å†…å®¹æ˜¯å¦å¡«å†™ï¼Œå¦‚æœæ²¡å¡«å†™å®Œæ•´åˆ™é˜»æ­¢ç™»å½•</a></li>
<li><a href="#4%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%AA%8C%E8%AF%81-2">(4)æœåŠ¡ç«¯éªŒè¯ã€‚</a>
<ul>
<li><a href="#41%E5%88%9B%E5%BB%BA%E7%99%BB%E5%BD%95%E8%B7%AF%E7%94%B1%E9%A1%B5%E9%9D%A2">ï¼ˆ4.1ï¼‰åˆ›å»ºç™»å½•è·¯ç”±é¡µé¢</a></li>
<li><a href="#42%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%E6%93%8D%E4%BD%9C">ï¼ˆ4.2ï¼‰ç™»å½•åŠŸèƒ½æ“ä½œ</a></li>
</ul>
</li>
<li><a href="#5%E5%AF%86%E7%A0%81%E6%AF%94%E5%AF%B9%E6%88%90%E5%8A%9F%E6%89%8D%E8%83%BD%E7%99%BB%E5%BD%95%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AFbcrypt">(5)å¯†ç æ¯”å¯¹æˆåŠŸæ‰èƒ½ç™»å½•(å¯†ç åŠ å¯†æŠ€æœ¯bcrypt)</a></li>
<li><a href="#6cookie%E4%B8%8Esession">(6)cookieä¸session</a></li>
<li><a href="#7%E7%94%A8%E6%88%B7%E9%80%80%E5%87%BA">(7)ç”¨æˆ·é€€å‡º</a></li>
<li><a href="#8%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA">(8)ç™»å½•æ‹¦æˆª</a></li>
</ul>
</li>
<li><a href="#%E4%BB%A3%E7%A0%81">ä»£ç </a></li>
</ul>

            </div>
          </div>
        </article>
      </div>

      
      <div class="next-post">
        <div class="next">ä¸‹ä¸€ç¯‡</div>
        <a href="https://qin_hu.gitee.io/blog/post/nodejs-shi-yong-mysql/">
          <h3 class="post-title">
            æ•°æ®åº“äº¤äº’ - nodeJsä½¿ç”¨mysql
          </h3>
        </a>
      </div>
      

      

      <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://qin_hu.gitee.io/blog//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>
<div id="backtop">
    <a href="#backtop" class="backTop" title="å›åˆ°é¡¶éƒ¨">
        <svg t="1702280870845" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
            p-id="5528" width="50" height="50">
            <path
                d="M679.936 482.176l0.32-0.32-157.44-157.44c-6.912-6.912-18.112-6.912-25.024 0L342.4 479.872 342.592 480c-10.88 11.776-6.208 34.624 10.816 51.648s39.872 21.632 51.648 10.816L405.12 542.592l62.336-62.336 0 195.648c0 24 19.392 43.52 43.392 43.52s43.392-19.52 43.392-43.52L554.24 481.28l61.696 61.696c0.064 0.064 0.064 0.064 0.128 0.128l0.128 0.064 1.408 1.408 0.192-0.192c12.032 9.728 33.984 4.928 50.56-11.584C684.8 516.16 689.6 494.208 679.936 482.176z"
                fill="#8F9EB230" p-id="5529"></path>
            <path
                d="M512 64C264.576 64 64 264.576 64 512s200.576 448 448 448c247.36 0 448-200.64 448-448S759.36 64 512 64zM512 864.256c-194.56 0-352.192-157.76-352.192-352.256C159.808 317.504 317.44 159.808 512 159.808c194.496 0 352.192 157.696 352.192 352.192C864.192 706.496 706.496 864.256 512 864.256z"
                fill="#8F9EB230" p-id="5530"></path>
        </svg>
    </a>
</div>
<style>
.backTop {
  width: 50px;
  height: 50px;
  position: fixed;
  bottom: 50px;
  right: 50px;
  text-align: center;
  line-height: 50px;
  transition: .5s ease-in-out;

}

.backTop:hover {
  transform: translateY(15px);
}

#backtop {
  position: absolute;
  top: 0px;
  z-index: 100;
  opacity: 0;
}
</style>
<script>
    const bodyDom = document.querySelector('body')
    const backTopDom = document.querySelector('#backtop')
    document.addEventListener('scroll', (e) => {
        // console.log(bodyDom.scrollTop)
        if (bodyDom.scrollTop > 3550) {
            backTopDom.style.opacity = 1
        } else {
            backTopDom.style.opacity = 0
        }
    })
</script>
      <!-- <div class="theme">
    <input class="switch-input" id="theme-switch" type="checkbox">
    <label class="switch-control" for="theme-switch"></label>
    <div class="container"></div>
</div>
 -->
    </div>
  </div>

  <script>
    // hljs.initHighlightingOnLoad()
    // hljs.highlightAll();
    document.addEventListener('DOMContentLoaded', () => {
      hljs.highlightAll();
    });
    let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

    // This should probably be throttled.
    // Especially because it triggers during smooth scrolling.
    // https://lodash.com/docs/4.17.10#throttle
    // You could do like...
    // window.addEventListener("scroll", () => {
    //    _.throttle(doThatStuff, 100);
    // });
    // Only not doing it here to keep this Pen dependency-free.

    window.addEventListener("scroll", event => {
      let fromTop = window.scrollY;

      mainNavLinks.forEach((link, index) => {
        let section = document.getElementById(decodeURI(link.hash).substring(1));
        let nextSection = null
        if (mainNavLinks[index + 1]) {
          nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
        }
        if (section.offsetTop <= fromTop) {
          if (nextSection) {
            if (nextSection.offsetTop > fromTop) {
              link.classList.add("current");
            } else {
              link.classList.remove("current");
            }
          } else {
            link.classList.add("current");
          }
        } else {
          link.classList.remove("current");
        }
      });
    });
  </script>
</body>

</html>